- command: pwd
  register: pwd
- name: make all
  docker_image:
      state: build
      name: "{{ item.name }}"
      docker_api_version: 1.18
      dockerfile: build/test/{{ item.name }}.Dockerfile
      path: "{{ pwd.stdout }}"
  with_items: "{{ images }}"

- name: stop all
  docker:
      name: "{{ item.name }}"
      state: stopped
      image: "{{ item.name }}"
      docker_api_version: 1.18
      stop_timeout: 2
  with_items: "{{ images }}"

- name: start all
  docker: 
      name: "{{ item.name }}"
      image: "{{ item.name }}"
      docker_api_version: 1.18
      state: started
      net: bridge
      links: "{{ item.links  }}"
      volumes: [ "{{ pwd.stdout }}/:/opt/nms" ]
  with_items: "{{ images }}"
- name: workaround to get nms-varnish-front-ip
  shell: "docker inspect nms-varnish-test | grep IPAddress | sed 's/[^0-9.]//g'"
  register: ip

- name: Display IP
  debug:
    msg: "Varnish test is available at http://{{ ip.stdout }}/"

