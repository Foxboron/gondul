---
- hosts: all
  become: false
  vars: 
  - images:
    - name: "nms-db-test"
      links: []
    - name: "nms-front-test"
      links: [ "nms-db-test:db" ]
    - name: "nms-varnish-test"
      links: [ "nms-front-test:nms-front" ]
    - name: "nms-collector-test"
      links: [ "nms-db-test:db" ]
  - simple_urls:
     - "/api/public/switches"
     - "/api/public/switch-state"
     - "/api/public/ping"
     - "/api/public/location"
     - "/api/public/dhcp"
     - "/api/public/dhcp-summary"
  - read_urls:
     - "/api/read/comments"
     - "/api/read/snmp"
     - "/api/read/switches-management"

  tasks:
  - command: pwd
    register: pwd
  - name: make all
    docker_image:
        state: build
        name: "{{ item.name }}"
        docker_api_version: 1.18
        dockerfile: build/test/{{ item.name }}.Dockerfile
        path: "{{ pwd.stdout }}"
    with_items: "{{ images }}"

  - name: stop all
    docker:
        name: "{{ item.name }}"
        state: stopped
        image: "{{ item.name }}"
        docker_api_version: 1.18
        stop_timeout: 2
    with_items: "{{ images }}"

  - name: start all
    docker: 
        name: "{{ item.name }}"
        image: "{{ item.name }}"
        docker_api_version: 1.18
        state: started
        net: bridge
        links: "{{ item.links  }}"
        volumes: [ "{{ pwd.stdout }}/:/opt/nms" ]
    with_items: "{{ images }}"
  - name: workaround to get nms-varnish-front-ip
    shell: "docker inspect nms-varnish-test | grep IPAddress | sed 's/[^0-9.]//g'"
    register: ip

  - name: Display IP
    debug:
      msg: "Front test is available at http://{{ ip.stdout }}/"

  - name: test index
    uri: url="http://{{ ip.stdout }}/"

  - name: test public api without data
    uri: 
       url: "http://{{ ip.stdout }}{{ item }}"
    with_items: "{{ simple_urls }}"

  - name: test read api without data
    uri: 
      url: http://{{ ip.stdout }}{{ item }}
      user: demo
      password: demo
    with_items: "{{ read_urls }}"
 
